stages:
  - build
  - doxygen
  - prod_image

variables:
  DOCKER_PROD_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

services:
  - docker:dind
  - mongo:3.6-stretch

build_job:ubuntu_18_04_release:
  image: registry.gitlab.com/neurochaintech/core/ubuntu:18.04
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Release"
  artifacts:
    paths:
      - build

build_job:ubuntu_18_04:
  image: registry.gitlab.com/neurochaintech/core/ubuntu:18.04
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Debug"
  artifacts:
    paths:
      - coverage.html
      - build

build_job:debian_9:
  image: registry.gitlab.com/neurochaintech/core/debian:sid
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Release"
  artifacts:
    paths:
      - build

build_job:fedora_28:
  image: registry.gitlab.com/neurochaintech/core/fedora:28
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Release"
  artifacts:
    paths:
      - build

prod_image_build:ubuntu_18_04:
  image: docker:stable
  stage: prod_image
  dependencies:
    - build_job:ubuntu_18_04
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -f Dockerfile -t $DOCKER_PROD_IMAGE .
    - docker push $DOCKER_PROD_IMAGE

pages:
  image: alpine
  stage: doxygen
  before_script:
    - apk update
    - apk add doxygen
    - apk add ttf-freefont graphviz
  script:
    - cd build && doxygen ../doc/Doxyfile
    - mv html ../public
    - mv ../coverage.html ../public
  dependencies:
    - build_job:ubuntu_18_04
  only:
    - milestone/0
  artifacts:
    paths:
      - public

.bot_build: &bot_build |
  function bot_build() {
    echo "Building in $1"
    mkdir build || echo k
    cd build
    cmake -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/root -DCMAKE_BUILD_TYPE=$1 ..
    cmake --build .
    # python3 ../tooling/times3.py ctest --output-on-failure
  }

before_script:
  - *bot_build
