stages:
  - build
  - prod_image
  - doxygen

variables:
  DOCKER_PROD_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_WALLET_IMAGE: $CI_REGISTRY_IMAGE/wallet
  DOCKER_FAUCET_IMAGE: $CI_REGISTRY_IMAGE/faucet
  DOCKER_BLOCK_EXPLORER_IMAGE: $CI_REGISTRY_IMAGE/block_explorer

services:
  - docker:dind
  - mongo:3.6-stretch

build_job:ubuntu_18_04:
  image: registry.gitlab.com/neurochaintech/core/ubuntu:18.04
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Debug"
  artifacts:
    paths:
      - coverage.html
      - build
      - testnet/data.0.testnet

#build_job:ubuntu_18_04_release:
#  image: registry.gitlab.com/neurochaintech/core/ubuntu:18.04
#  stage: build
#  tags:
#    - cpp
#  script:
#    - bot_build "Release"
#  artifacts:
#    paths:
#      - build
#
#
#build_job:debian_9:
#  image: registry.gitlab.com/neurochaintech/core/debian:sid
#  stage: build
#  tags:
#    - cpp
#  script:
#    - bot_build "Release"
#  artifacts:
#    paths:
#      - build
#
#build_job:fedora_28:
#  image: registry.gitlab.com/neurochaintech/core/fedora:28
#  stage: build
#  tags:
#    - cpp
#  script:
#    - bot_build "Release"
#  artifacts:
#    paths:
#      - build
#
prod_image_build:ubuntu_18_04:
  image: docker:stable
  stage: prod_image
  variables:
    DOCKER_DRIVER: overlay2
  services:
    - docker:stable-dind
  dependencies:
    - build_job:ubuntu_18_04
  only:
    - feature/ledger
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -f utils/dockers/Dockerfile.core -t $DOCKER_PROD_IMAGE:latest -t $DOCKER_PROD_IMAGE:$CI_COMMIT_SHA  .
    - docker push $DOCKER_PROD_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKER_PROD_IMAGE:latest
    - docker build -f utils/dockers/Dockerfile.wallet -t $DOCKER_WALLET_IMAGE:latest -t $DOCKER_WALLET_IMAGE:$CI_COMMIT_SHA  .
    - docker push $DOCKER_WALLET_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKER_WALLET_IMAGE:latest
    - docker build -f utils/dockers/Dockerfile.faucet -t $DOCKER_FAUCET_IMAGE:latest -t $DOCKER_FAUCET_IMAGE:$CI_COMMIT_SHA  .
    - docker push $DOCKER_FAUCET_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKER_FAUCET_IMAGE:latest
    - docker build -f utils/dockers/Dockerfile.block -t $DOCKER_BLOCK_EXPLORER_IMAGE:latest -t $DOCKER_BLOCK_EXPLORER_IMAGE:$CI_COMMIT_SHA  .
    - docker push $DOCKER_BLOCK_EXPLORER_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKER_BLOCK_EXPLORER_IMAGE:latest



pages:
  image: alpine
  stage: doxygen
  before_script:
    - apk update
    - apk add doxygen
    - apk add ttf-freefont graphviz
  script:
    - cd build && doxygen ../doc/Doxyfile
    - mv html ../public
    - mv ../coverage.html ../public
  dependencies:
    - build_job:ubuntu_18_04
  only:
    - feature/ledger
  artifacts:
    paths:
      - public

.bot_build: &bot_build |
  function bot_build() {
    echo "Building in $1"
    set -ex 
    export BUILD_TYPE=$1
    mkdir build || echo k
    cd build
    cmake -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/root -DCMAKE_BUILD_TYPE=$1 ..
    make -j5
    mkdir /tmp/db && nohup mongod --dbpath /tmp/db & 
    sleep 5
    python3 ../utils/dockers/times3.py ctest -V || echo ok
    cd .. && python3 -m gcovr -p -r . --html -o coverage.html
  }

before_script:
  - *bot_build
 
