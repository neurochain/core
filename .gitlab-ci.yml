stages:
  - build
  - doxygen

services:
  - mongo:3.6-stretch

build_job:ubuntu_18_04_release:
  image: registry.gitlab.com/neurochaintech/core/ubuntu:18.04
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Release"
  artifacts:
    paths:
      - build

build_job:ubuntu_18_04:
  image: registry.gitlab.com/neurochaintech/core/ubuntu:18.04
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Debug"
  artifacts:
    paths:
      - coverage.html
      - build

build_job:debian_9:
  image: registry.gitlab.com/neurochaintech/core/debian:sid
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Release"
  artifacts:
    paths:
      - build

build_job:fedora_28:
  image: registry.gitlab.com/neurochaintech/core/fedora:28
  stage: build
  tags:
    - cpp
  script:
    - bot_build "Release"
  artifacts:
    paths:
      - build

pages:
  image: alpine
  stage: doxygen
  before_script:
    - apk update
    - apk add doxygen
    - apk add ttf-freefont graphviz
  script:
    - cd build && doxygen ../doc/Doxyfile
    - mv html ../public
    - mv ../coverage.html ../public
  dependencies:
    - build_job:ubuntu_18_04
  only:
    - milestone/0
  artifacts:
    paths:
      - public

.bot_build: &bot_build |
  function bot_build() {
    mkdir build || echo k
    cd build
    cmake -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/root -DCMAKE_BUILD_TYPE=$1 ..
    cmake --build .
    python3 ../tooling/times3.py ctest --output-on-failure
  }

before_script:
  - *bot_build
